# Skymind CI/CD Kubernetes cluster deployment and configuring

## Prerequisites
To be able to deploy new k8s cluster instance following tools should be present on VM:
1. Azure account;
2. [Azure CLI](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest);
3. [ACS-engine](https://github.com/Azure/acs-engine/blob/master/docs/acsengine.md#install);
4. [Cluster definition template](https://github.com/Azure/acs-engine/blob/master/docs/clusterdefinition.md).

## Cluster deployment
All deployment process of fresh Kubernetes cluster is done according with tool's instruction [here](https://github.com/Azure/acs-engine/blob/master/docs/kubernetes/deploy.md).

Below, you can find shortened set of steps that are required for cluster deployment:
1. Create cluster resource group, naming convention is following: `ci-skymind-<env-name>-acs-cluster-<cluster-number>`

   <span style="color:orange">_**Step 2 can be omitted, if cluster doesn't need nodes autoscaling**_</span>
2. Create `service principal` for `cluster-autoscaler` (tool that automatically adjusts the size of the Kubernetes cluster node pools).
3. Run `acs-engine deploy` with following options:
    * subscription-id - Azure subscription id;
    * location - Azure region;
    * api-model - path to cluster definition template;
    * resource-group - Azure resource group;
    * force-overwrite - this option is required if `acs-engine deploy` command triggered several times.

   Service principal for cluster will be created automatically.
4. Move (from previous cluster deployment) or create new Azure public IP address for [Kubernetes ingress controller](https://kubernetes.io/docs/concepts/services-networking/ingress/).
   If public IP address has been created from scratch, DNS record should be updated at [Cloudflare](https://www.cloudflare.com/).


## Cluster version upgrade
To upgrade Kubernetes version of already deployed cluster you can use `acs-engine upgrade` command with following options:
* subscription-id - Azure subscription id;
* deployment-dir - ACS-engine output directory (_output/<cluster id>);
* location - Azure region for already existing cluster;
* resource-group - Azure resource group for already existing cluster;
* upgrade-version - desired Kubernetes version;
* auth-method - value is `client_secret`;
* client-id - client id from cluster definition JSON;
* client-secret - client secret from cluster definition.

## Cluster update
To update separate parts of already deployed cluster (change instance type for the pool, add new pool, remove existing pool) following steps should be applied:
1. Update `cluster definition template`.
2. Run `acs-engine generate --api-model <path-to-the-cluster-definition-template>`, to update previously generated ARM template.
3. Schedule ARM deployment, to apply changes with following command `az group deployment create` and options:
    * name - unique deployment name, used as identifier for specific deployment;
    * resource-group - Azure resource group for already existing cluster;
    * template-file - path to the `azuredeploy.json` file that was generated by `acs-engine generate` command (typically resides in `_output/<cluster-name>` folder);
    * parameters - path to the `azuredeploy.parameters.json` file that was generated by `acs-engine generate` command (typically resides in `_output/<cluster-name>` folder).

## Issues/Improvements
1. Switch to [kubespray](http://kubespray.io/) or similar tool, to be able to deploy Kubernetes cluster to other clouds or on premise.
2. Add monitoring/logging.
3. Add Windows pool.
4. Add Linux GPU pool.